<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.malicn.server.dao.auth.AuthVehicleDao" >
  <resultMap id="AuthVehicleMap" type="com.malicn.server.domain.auth.AuthVehicle" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="carrier_id" property="carrierId" jdbcType="BIGINT" />
    <result column="plate_no" property="plateNo" jdbcType="VARCHAR" />
    <result column="vehicle_type" property="vehicleType" jdbcType="TINYINT" />
    <result column="length" property="length" jdbcType="DECIMAL" />
    <result column="weight" property="weight" jdbcType="DECIMAL" />
    <result column="min_tmprtu" property="minTmprtu" jdbcType="DECIMAL" />
    <result column="cargo_ctgry_id" property="cargoCtgryId" jdbcType="VARCHAR" />
    <result column="cargo_ctgry_name" property="cargoCtgryName" jdbcType="VARCHAR" />
    <result column="licn_img" property="licnImg" jdbcType="VARCHAR" />
    <result column="vehicle_img" property="vehicleImg" jdbcType="VARCHAR" />
    <result column="audit_status" property="auditStatus" jdbcType="TINYINT" />
    <result column="audit_time" property="auditTime" jdbcType="TIMESTAMP" />
    <result column="audit_remark" property="auditRemark" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="is_deleted" property="isDeleted" jdbcType="TINYINT" />
    <!-- 外加字段 ml_user_driver表 -->
    <result column="real_name" property="realName" />
    <result column="license_no" property="idCardNo" />
    <result column="auth_status" property="authStatus" />
  </resultMap>
  <!-- 全字段 -->
  <sql id="Base_Column_List" >
    id, carrier_id, plate_no, vehicle_type, length, weight, min_tmprtu, cargo_ctgry_id, cargo_ctgry_name,
    licn_img, vehicle_img, audit_status, audit_time, audit_remark, create_time, update_time, is_deleted
  </sql>

  <sql id="Join_Base_Column_List">
    a.id, a.carrier_id, a.plate_no, a.vehicle_type, a.length, a.weight, a.min_tmprtu, a.cargo_ctgry_id, a.cargo_ctgry_name,
    a.licn_img, a.vehicle_img, a.audit_status, a.audit_time, a.audit_remark, a.create_time, a.update_time, a.is_deleted
  </sql>

  <!-- 根据用户ID去查询车辆认证信息 -->
  <select id="getByCarrierId" resultMap="AuthVehicleMap">
    SELECT <include refid="Base_Column_List" />
    FROM ml_auth_vehicle
    WHERE carrier_id = #{userId}
    ORDER BY create_time DESC LIMIT 1
  </select>

  <!-- 保存车辆认证信息 -->
  <insert id="saveAuthVehicle" parameterType="com.malicn.server.domain.auth.AuthVehicle">
    INSERT INTO ml_auth_vehicle (carrier_id, plate_no, vehicle_type, length, weight, min_tmprtu, cargo_ctgry_id, cargo_ctgry_name, licn_img, vehicle_img, audit_status, create_time)
    VALUES (#{carrierId}, #{plateNo}, #{vehicleType}, #{length}, #{weight}, #{minTmprtu}, #{cargoCtgryId}, #{cargoCtgryName}, #{licnImg}, #{vehicleImg}, #{auditStatus}, now())
  </insert>

  <!-- 查询未审核的车辆认证信息 -->
  <select id="getWSHAuthVehicle" resultMap="AuthVehicleMap">
    SELECT <include refid="Base_Column_List" />
    FROM ml_auth_vehicle
    WHERE carrier_id = #{userId}
    AND audit_status = 0
    ORDER BY create_time DESC LIMIT 1
  </select>



  <!-- 编辑车辆信息 -->
  <update id="updateAuthVehicle" parameterType="com.malicn.server.domain.auth.AuthVehicle">
    UPDATE ml_auth_vehicle
    <set>
      <if test="plateNo != null">
        plate_no = #{plateNo},
      </if>
      <if test="length != null">
        length = #{length},
      </if>
      <if test="weight != null">
        weight = #{weight},
      </if>
      <if test="minTmprtu != null">
        min_tmprtu = #{minTmprtu},
      </if>
      <if test="vehicleType != null">
        vehicle_type = #{vehicleType},
      </if>
      <if test="cargoCtgryId != null">
        cargo_ctgry_id = #{cargoCtgryId},
      </if>
      <if test="cargoCtgryName != null">
        cargo_ctgry_name = #{cargoCtgryName},
      </if>
      update_time = now()
    </set>
    WHERE id = #{id}
  </update>

  <!-- 根据车主ID和车牌号去查询 -->
  <select id="getByPlNoUId" resultMap="AuthVehicleMap">
    SELECT <include refid="Base_Column_List"/>
    FROM ml_auth_vehicle
    WHERE carrier_id = #{carrierId} AND plate_no = #{plateNo}
    ORDER BY create_time desc
    limit 1
  </select>

  <!-- 逻辑删除车辆认证数据 -->
  <delete id="deleteAuthVehicle">
    UPDATE ml_auth_vehicle SET is_deleted = 1 WHERE id = #{authVehicleId};
  </delete>


  <select id="getAuthVehicleByParams" resultMap="AuthVehicleMap">
    SELECT <include refid="Join_Base_Column_List" />, b.real_name, b.license_no, b.auth_status
    FROM ml_auth_vehicle a
    LEFT JOIN ml_user_driver b
    ON a.carrier_id = b.user_id
    WHERE audit_status != 1
    <if test="plateNo != null and plateNo != ''">
      AND LOCATE(#{plateNo}, a.plate_no) > 0
    </if>
    <if test="auditStatus !=null and auditStatus !=''">
      AND a.audit_status = #{auditStatus}
    </if>
    ORDER BY a.create_time ASC
  </select>
  <select id="getAuthVehicleByCarrierId"  resultMap="AuthVehicleMap" parameterType="java.lang.Long">
    SELECT <include refid="Join_Base_Column_List" />, b.real_name, b.license_no, b.auth_status
    FROM ml_auth_vehicle a
    LEFT JOIN ml_user_driver b
    ON a.carrier_id = b.user_id
    AND a.audit_status != 0
    WHERE a.carrier_id = #{carrierId}
  </select>
  <update id="updateByAuditStatus">
    UPDATE ml_auth_vehicle
    SET audit_status = #{auditStatus},
    audit_remark = #{auditRemark},
    audit_time = now()
    WHERE id = #{auditId}
  </update>
  <select id="getById" resultMap="AuthVehicleMap" parameterType="java.lang.Long">
    SELECT <include refid="Join_Base_Column_List" />, b.real_name, b.license_no, b.auth_status
    FROM ml_auth_vehicle a
    LEFT JOIN ml_user_driver b
    ON a.carrier_id = b.user_id
    WHERE a.id = #{auditId}
  </select>
</mapper>