<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.malicn.server.dao.redpacket.RedPacketDao" >
<resultMap id="redPacketMap" type="com.malicn.server.domain.redpacket.RedPacket" >
  <id column="id" property="id" jdbcType="BIGINT" />
  <result column="carrier_id" property="carrierId" jdbcType="BIGINT"/>
  <result column="amount" property="amount" jdbcType="DECIMAL" />
  <result column="status" property="status" jdbcType="TINYINT" />
  <result column="info" property="info" jdbcType="VARCHAR" />
  <result column="expried_time" property="expriedTime" jdbcType="TIMESTAMP" />
  <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
  <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
  <result column="is_deleted" property="isDeleted" jdbcType="TINYINT" />
</resultMap>

<sql id="table_name">ml_balance_log</sql>
<sql id="all_columns">id,carrier_id,amount,status,info,expried_time,create_time,update_time,is_deleted</sql>

<!--列举我所有的红包-->
<select id="listMyRedPackets" parameterType="long" resultMap="redPacketMap">
  SELECT <include refid="all_columns"/>
  FROM ml_red_packet
  WHERE carrier_id=#{userId} ORDER BY create_time DESC
</select>

<!--通过红包id获取红包-->
<select id="getRedPacketById" parameterType="long" resultMap="redPacketMap">
  SELECT <include refid="all_columns"/>
  FROM ml_red_packet
  WHERE id=#{redPacketId}
</select>

<!--更新红包的状态-->
<update id="updateRedPacketStatus">
  UPDATE ml_red_packet set status = #{status} where id = #{redPacketId}
</update>

<!-- 更新红包的状态为过期 -->
<update id="expiredUnReceiveRedPacket">
  UPDATE ml_red_packet SET status =2 WHERE status=0 and expried_time  &lt; #{now}
</update>

<!-- 查询未领取的红包 -->
<select id="getUnclaimedRdPk" resultMap="redPacketMap">
  SELECT <include refid="all_columns" />
  FROM ml_red_packet
  WHERE status = 0 AND is_deleted = 0 AND carrier_id = #{userId} limit 1;
</select>

</mapper>