<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.malicn.server.dao.vehicle.VehicleDao" >

    <resultMap id="vehicleMap" type="com.malicn.server.domain.vehicle.Vehicle">
        <id column="id" property="id" />
        <result column="carrier_id" property="carrierId" />
        <result column="driver_id" property="driverId" />
        <result column="plate_no" property="plateNo" />
        <result column="vehicle_type" property="vehicleType" />
        <result column="length" property="length" />
        <result column="weight" property="weight" />
        <result column="min_tmprtu" property="minTmprtu" />
        <result column="cargo_ctgry_id" property="cargoCtgryId" />
        <result column="cargo_ctgry_name" property="cargoCtgryName" />
        <result column="license_no" property="licenseNo" />
        <result column="licn_exp_date" property="licnExpDate" />
        <result column="licn_img" property="licnImg" />
        <result column="vehicle_img" property="vehicleImg" />
        <result column="auth_status" property="authStatus" />
        <result column="auth_pass_time" property="authPassTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <sql id="Base_Column_List" >
        id, carrier_id, driver_id, plate_no, vehicle_type, length, weight, min_tmprtu, cargo_ctgry_id,
        cargo_ctgry_name, license_no, licn_exp_date, licn_img, vehicle_img, auth_status,
        auth_pass_time, create_time, update_time
    </sql>
    <!-- 新增操作 -->
    <insert id="saveVehicle" parameterType="com.malicn.server.domain.vehicle.Vehicle" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ml_vehicle
        (carrier_id,driver_id,plate_no,vehicle_type,length,weight,min_tmprtu,cargo_ctgry_id,cargo_ctgry_name,license_no,licn_exp_date,licn_img,vehicle_img,auth_status,auth_pass_time,create_time,update_time)
        VALUES
        (#{carrierId},#{driverId},#{plateNo},#{vehicleType},#{length},#{weight},#{minTmprtu},#{cargoCtgryId},#{cargoCtgryName},#{licenseNo},#{licnExpDate},#{licnImg},#{vehicleImg},#{authPassTime},#{authTime},now(),now())
    </insert>

    <insert id="insertSelective"  useGeneratedKeys="true"  keyProperty="id" parameterType="com.malicn.server.domain.vehicle.Vehicle" >
        insert into ml_vehicle
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="carrierId != null" >
                carrier_id,
            </if>
            <if test="driverId != null" >
                driver_id,
            </if>
            <if test="plateNo != null" >
                plate_no,
            </if>
            <if test="vehicleType != null" >
                vehicle_type,
            </if>
            <if test="length != null" >
                length,
            </if>
            <if test="weight != null" >
                weight,
            </if>
            <if test="minTmprtu != null" >
                min_tmprtu,
            </if>
            <if test="cargoCtgryId != null" >
                cargo_ctgry_id,
            </if>
            <if test="cargoCtgryName != null" >
                cargo_ctgry_name,
            </if>
            <if test="licenseNo != null" >
                license_no,
            </if>
            <if test="licnExpDate != null" >
                licn_exp_date,
            </if>
            <if test="licnImg != null" >
                licn_img,
            </if>
            <if test="vehicleImg != null" >
                vehicle_img,
            </if>
            <if test="authStatus != null" >
                auth_status,
            </if>
            auth_pass_time,
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=BIGINT},
            </if>
            <if test="carrierId != null" >
                #{carrierId,jdbcType=BIGINT},
            </if>
            <if test="driverId != null" >
                #{driverId,jdbcType=BIGINT},
            </if>
            <if test="plateNo != null" >
                #{plateNo,jdbcType=VARCHAR},
            </if>
            <if test="vehicleType != null" >
                #{vehicleType,jdbcType=TINYINT},
            </if>
            <if test="length != null" >
                #{length,jdbcType=DECIMAL},
            </if>
            <if test="weight != null" >
                #{weight,jdbcType=DECIMAL},
            </if>
            <if test="minTmprtu != null" >
                #{minTmprtu,jdbcType=DECIMAL},
            </if>
            <if test="cargoCtgryId != null" >
                #{cargoCtgryId,jdbcType=VARCHAR},
            </if>
            <if test="cargoCtgryName != null" >
                #{cargoCtgryName,jdbcType=VARCHAR},
            </if>
            <if test="licenseNo != null" >
                #{licenseNo,jdbcType=VARCHAR},
            </if>
            <if test="licnExpDate != null" >
                #{licnExpDate,jdbcType=DATE},
            </if>
            <if test="licnImg != null" >
                #{licnImg,jdbcType=VARCHAR},
            </if>
            <if test="vehicleImg != null" >
                #{vehicleImg,jdbcType=VARCHAR},
            </if>
            <if test="authStatus != null" >
                #{authStatus,jdbcType=TINYINT},
            </if>
            now(),
            now()
        </trim>
    </insert>

    <!-- 修改操作 -->
    <update id="updateVehicle" parameterType="com.malicn.server.domain.vehicle.Vehicle" >
        UPDATE ml_vehicle
        <set>
            <if test="carrierId != null">
              carrier_id = #{carrierId},
            </if>
            <if test="driverId != null">
                driver_id = #{driverId},
            </if>
            <if test="plateNo != null">
              plate_no = #{plateNo},
            </if>
            <if test="vehicleType != null">
                vehicle_type = #{vehicleType},
            </if>
            <if test="length != null">
              length = #{length},
            </if>
            <if test="weight != null">
              weight = #{weight},
            </if>
            <if test="minTmprtu != null">
              min_tmprtu = #{minTmprtu},
            </if>
            <if test="cargoCtgryId != null">
              cargo_ctgry_id = #{cargoCtgryId},
            </if>
            <if test="cargoCtgryName != null">
              cargo_ctgry_name = #{cargoCtgryName},
            </if>
            <if test="licenseNo != null">
              license_no = #{licenseNo},
            </if>
            <if test="licnExpDate != null">
              licn_exp_date = #{licnExpDate},
            </if>
            <if test="licnImg != null">
              licn_img = #{licnImg},
            </if>
            <if test="vehicleImg != null">
              vehicle_img = #{vehicleImg},
            </if>
            <if test="authStatus != null">
                auth_status = #{authStatus},
            </if>
            update_time = now()
        </set>
        <where>
            id = #{id}
        </where>
    </update>
    <update id="updateAuthStatus">
        UPDATE ml_vehicle SET auth_status = #{vehicleStatus}
        WHERE id = #{vehicleId}
    </update>

    <select id="getPlateNoByDriverId" resultType="java.lang.String">
        SELECT plate_no FROM ml_vehicle WHERE driver_id = #{driverId} AND auth_status = 1
    </select>

    <select id="getVehicleIdByDriverId" resultType="java.lang.Long">
        SELECT v.id
        FROM ml_vehicle v
        WHERE v.driver_id = #{driverId}
    </select>

    <select id="getByPlateNo" resultMap="vehicleMap" parameterType="java.lang.String">
        SELECT <include refid="Base_Column_List"/>
        FROM ml_vehicle
        WHERE plate_no = #{pltNo} AND auth_status = 1
        limit 1
    </select>

    <select id="getByPersonalDriver" resultMap="vehicleMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ml_vehicle
        WHERE carrier_id = #{driverId}
        limit 1;
    </select>


    <delete id="deletedByphciol" parameterType="java.lang.Long">
        DELETE FROM ml_vehicle
        WHERE id = #{id}
    </delete>

    <!-- 删除车辆 -->
    <delete id="deleteVehicle" parameterType="java.lang.Long">
        DELETE FROM ml_vehicle WHERE id = #{vehicleId}
    </delete>

    <!-- 根据车牌号、司机ID、车辆ID查询车辆 -->
    <select id="getVehicleByPLNoUIdVId" resultMap="vehicleMap">
        SELECT <include refid="Base_Column_List" />
        FROM ml_vehicle
        WHERE id = #{vehicleId} AND plate_no = #{plateNo} AND carrier_id = #{driverId}
    </select>


    <!--============================================CMS系统新增 ======================================== -->
    <sql id="vehicle_all_columns">
        a.id, a.driver_id, a.carrier_id, a.vehicle_type, a.plate_no, a.length, a.weight, a.min_tmprtu, a.cargo_ctgry_id,
        a.cargo_ctgry_name, a.license_no, a.licn_exp_date,
        a.licn_img, a.auth_status, a.create_time, a.update_time, a.auth_pass_time, a.vehicle_img
    </sql>


    <resultMap id="driverVehicleMap" extends="vehicleMap" type="com.malicn.server.domain.vehicle.DriverVehicle">
        <result column="driver_name" property="driverName" />
        <result column="driver_mobile" property="driverMobile" />
        <result column="vehicle_id" property="vehicleId" />
        <result column="carrier_name" property="carrierName" />

    </resultMap>


    <select id="selectById" resultMap="vehicleMap">
        SELECT <include refid="Base_Column_List" />
        FROM ml_vehicle
        WHERE id = #{vehicleId}
    </select>



    <select id="listByKeyWord" resultMap="driverVehicleMap">
    <!--列举所有司机、议价者ID、车辆情况 -->
    SELECT
        t.carrier_id,
        m.driver_id,
        t.vehicle_id,
        m.plate_no,
        m.vehicle_type,
        m.length,
        m.weight,
        m.min_tmprtu,
        ifnull(carrier.real_name,carrier.company_name)  as carrier_name,
        driver.real_name    as  driver_name,
        d.mobile as  driver_mobile
     FROM
        (select
        v.vehicle_id,
        carrier_id  AS carrier_id
        from
        ml_carrier_vehicle v
        where v.carrier_id = 1
        union all
        select
        v.vehicle_id,
        carrier_id  AS carrier_id
        from
        ml_carrier_vehicle v
        where v.vehicle_id not in (
            select
            v.vehicle_id
            from
            ml_carrier_vehicle v
            where v.carrier_id = 1
        )) t
        INNER JOIN ml_vehicle m ON t.vehicle_id = m.id
        inner join ml_user_carrier  carrier on t.carrier_id =carrier.user_id
        inner join ml_user_base d  on m.driver_id = d.user_id
        inner join ml_user_driver driver on m.driver_id = driver.user_id
    where  (m.plate_no like concat('%',#{wd},'%')
        or m.length like concat('%',#{wd},'%')
        or m.weight like concat('%',#{wd},'%')
        or m.min_tmprtu like concat('%',#{wd},'%')
        or driver.real_name like concat('%',#{wd},'%')
        or carrier.real_name like concat('%',#{wd},'%')
        or d.mobile  like concat('%',#{wd},'%'))
    order by driver.create_time
        limit 50
    </select>

    <!-- cms 车辆列表 -->
    <select id="listVehicle" resultMap="driverVehicleMap">
        SELECT <include refid="vehicle_all_columns" />, b.real_name as driver_name, c.real_name carrier_name
        FROM ml_vehicle a
        LEFT JOIN ml_user_driver b
        ON a.driver_id = b.user_id
        LEFT JOIN ml_user_carrier c
        ON a.carrier_id = c.user_id
        WHERE 1=1
        <if test="authStatus != null">
            AND a.auth_status = #{authStatus}
        </if>
        <if test="plateNo != null and plateNo != ''">
            AND (LOCATE(#{plateNo}, a.plate_no) >0)
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- 根据车辆Id查询车辆和司机信息 -->
    <select id="getDriverVehicleById" resultMap="driverVehicleMap" parameterType="java.lang.Long">
        SELECT <include refid="vehicle_all_columns" />, b.real_name as driver_name, c.real_name carrier_name
        FROM ml_vehicle a
        LEFT JOIN ml_user_driver b
        ON a.driver_id = b.user_id
        LEFT JOIN ml_user_carrier c
        ON a.carrier_id = c.user_id
        WHERE a.id = #{vehicleId}
    </select>
    <select id="getByLicenseNo" resultMap="driverVehicleMap" parameterType="java.lang.String">
        SELECT <include refid="Base_Column_List" />
        FROM ml_vehicle
        WHERE license_no = #{licenceNo}
        AND auth_status = 1
        limit 1
    </select>

</mapper>