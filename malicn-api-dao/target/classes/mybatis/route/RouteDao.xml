<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.malicn.server.dao.route.RouteDao" >

    <resultMap id="RouteMap" type="com.malicn.server.domain.route.Route" >
        <id property="id" column="id" />
        <result property="startName" column="start_name" />
        <result property="arriveName" column="arrive_name" />
        <result property="startId" column="start_id"/>
        <result property="arriveId" column="arrive_id" />
        <result property="unitPrice" column="unit_price"/>
        <result property="unitMin" column="unit_min" />
        <result property="unitMax" column="unit_max" />
        <result property="creator" column="creator" />
        <result property="updater" column="updater" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
        <result property="isDeleted" column="is_deleted" />
    </resultMap>

    <sql id="Base_Column_List" >
        id, start_name, arrive_name, start_id, arrive_id, unit_price, unit_min, unit_max,
        create_time, creator, update_time, updater, is_deleted
    </sql>

    <insert id="insertSelective" parameterType="com.malicn.server.domain.route.Route" >
        insert into ml_route
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="startName != null" >
                start_name,
            </if>
            <if test="arriveName != null" >
                arrive_name,
            </if>
            <if test="startId != null" >
                start_id,
            </if>
            <if test="arriveId != null" >
                arrive_id,
            </if>
            <if test="unitPrice != null" >
                unit_price,
            </if>
            <if test="unitMin != null" >
                unit_min,
            </if>
            <if test="unitMax != null" >
                unit_max,
            </if>
            <if test="creator != null" >
                creator,
            </if>
            <if test="updater != null" >
                updater,
            </if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=INTEGER},
            </if>
            <if test="startName != null" >
                #{startName,jdbcType=VARCHAR},
            </if>
            <if test="arriveName != null" >
                #{arriveName,jdbcType=VARCHAR},
            </if>
            <if test="startId != null" >
                #{startId,jdbcType=INTEGER},
            </if>
            <if test="arriveId != null" >
                #{arriveId,jdbcType=INTEGER},
            </if>
            <if test="unitPrice != null" >
                #{unitPrice,jdbcType=DECIMAL},
            </if>
            <if test="unitMin != null" >
                #{unitMin,jdbcType=DECIMAL},
            </if>
            <if test="unitMax != null" >
                #{unitMax,jdbcType=DECIMAL},
            </if>
            <if test="creator != null" >
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="updater != null" >
                #{updater,jdbcType=VARCHAR},
            </if>
            now()
        </trim>
    </insert>

    <update id="updateByPrimaryKeySelective" parameterType="com.malicn.server.domain.route.Route" >
        update ml_route
        <set >
            <if test="startName != null" >
                start_name = #{startName,jdbcType=VARCHAR},
            </if>
            <if test="arriveName != null" >
                arrive_name = #{arriveName,jdbcType=VARCHAR},
            </if>
            <if test="startId != null" >
                start_id = #{startId,jdbcType=INTEGER},
            </if>
            <if test="arriveId != null" >
                arrive_id = #{arriveId,jdbcType=INTEGER},
            </if>
            <if test="unitPrice != null" >
                unit_price = #{unitPrice,jdbcType=DECIMAL},
            </if>
            <if test="unitMin != null" >
                unit_min = #{unitMin,jdbcType=DECIMAL},
            </if>
            <if test="unitMax != null" >
                unit_max = #{unitMax,jdbcType=DECIMAL},
            </if>
            <if test="creator != null" >
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="updater != null" >
                updater = #{updater,jdbcType=VARCHAR},
            </if>
            <if test="isDeleted != null" >
                is_deleted = #{isDeleted,jdbcType=TINYINT},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <!-- 查询所有路线-->
    <select id="getAll" resultMap="RouteMap">
        SELECT id,start_name, arrive_name, start_id,arrive_id,unit_price,create_time
        FROM ml_route
        WHERE is_deleted = 0
    </select>

    <!-- 根据出发地id和目的地id查询路线估价 -->
    <select id="getRouteByStartAndArrive" resultMap="RouteMap">
        SELECT id,start_name, arrive_name, unit_price
        FROM ml_route
        WHERE start_id = #{startId} AND arrive_id = #{arriveId} AND is_deleted = 0
    </select>

    <!-- 查询出发地1级地名 -->
    <select id="listOneLevelInRouteForStart" resultMap="com.malicn.server.dao.sys.RegionDao.RegionMap">
        SELECT <include refid="com.malicn.server.dao.sys.RegionDao.all_columns" /> FROM ml_region
        WHERE id IN (
            SELECT parent_id FROM ml_region
            WHERE id IN (
                SELECT DISTINCT(start_id) FROM ml_route WHERE is_deleted = 0
            ))
        AND id > 1 ORDER BY sort
    </select>

    <!-- 查询出发地2级地名 -->
    <select id="listTwoLevelInRouteByParentForStart" resultMap="com.malicn.server.dao.sys.RegionDao.RegionMap">
        SELECT <include refid="com.malicn.server.dao.sys.RegionDao.all_columns" /> FROM ml_region
        WHERE id IN (
        SELECT a.start_id
        FROM ml_route a
        LEFT JOIN ml_region b
        ON a.start_id = b.id
        WHERE b.parent_id = #{parentId} AND a.is_deleted = 0
        )
         ORDER BY id
    </select>

    <!-- 查询目的地1级地名 -->
    <select id="listOneLevelInRouteForArrive" resultMap="com.malicn.server.dao.sys.RegionDao.RegionMap">
        SELECT <include refid="com.malicn.server.dao.sys.RegionDao.all_columns" /> FROM ml_region
        WHERE id IN (
            SELECT parent_id FROM ml_region
            WHERE id IN (
               SELECT DISTINCT(arrive_id) FROM ml_route WHERE start_id = #{startId} AND is_deleted = 0
            ))
        AND id > 1 ORDER BY sort
    </select>

    <!-- 查询目的地2级地名 -->
    <select id="listTwoLevelInRouteByParentForArrive" resultMap="com.malicn.server.dao.sys.RegionDao.RegionMap">
        SELECT <include refid="com.malicn.server.dao.sys.RegionDao.all_columns" /> from ml_region WHERE parent_id = #{arriveAid} AND id IN (
        SELECT a.arrive_id
            FROM ml_route a
            LEFT JOIN ml_region b
            ON a.start_id = b.id
            WHERE a.start_id = #{parentId} and a.is_deleted = 0) ORDER BY id
    </select>
</mapper>