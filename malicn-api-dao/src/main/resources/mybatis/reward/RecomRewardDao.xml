<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.malicn.server.dao.reward.RecomRewardDao" >

  <resultMap id="RecomRewardMap" type="com.malicn.server.domain.reward.RecomReward" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="user_id" property="userId" jdbcType="BIGINT" />
    <result column="vip_id" property="vipId"/>
    <result column="vip_name" property="vipName" />
    <result column="referee_id" property="refereeId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="BIGINT" />
    <result column="weight" property="weight" jdbcType="DECIMAL" />
    <result column="amount" property="amount" jdbcType="DECIMAL" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="createTimeMonth" property="createTimeMonth" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="all_column" >
    id, user_id, vip_id, vip_name, referee_id, order_id, weight, amount, create_time, update_time
  </sql>

  <sql id="base_column" >
    user_id, referee_id, order_id, weight, amount, create_time,
    <!--@author qun.xu @desc vip_id ,vip_name-->
    vip_id,vip_name
  </sql>

  <!-- 查询用户累计推荐订单奖励 -->
  <select id="countRecomReward" resultType="java.math.BigDecimal">
    SELECT SUM(amount) FROM ml_recom_reward WHERE  vip_id=#{vipId}
</select>


  <!-- 推荐人的奖励列表 -->
  <select id="getRecomRewardsMonth" resultMap="RecomRewardMap" parameterType="com.malicn.server.dao.balance.BaseQueryDTO">
    SELECT
    t.user_id,
    SUM(t.`amount`) as  amount,
    SUM(t.`weight`) as  weight,
    DATE_FORMAT(t.create_time,'%Y-%m') createTimeMonth
    FROM ml_recom_reward t
    WHERE user_id = #{userId} AND DATE_FORMAT(t.create_time,'%Y-%m')<![CDATA[<]]>DATE_FORMAT(NOW(),'%Y-%m')
    AND vip_name = #{vipName}
    GROUP BY DATE_FORMAT(t.create_time,'%Y-%m'),t.user_id
    order by  DATE_FORMAT(t.create_time,'%Y-%m') desc
  </select>



  <!-- 推荐人的奖励列表 -->
  <select id="getRecomRewards" resultMap="RecomRewardMap" parameterType="com.malicn.server.dao.balance.BaseQueryDTO">
    SELECT
    <include refid="all_column"/>
    FROM ml_recom_reward t  WHERE user_id = #{userId} AND vip_name = #{vipName}
    order by t.create_time desc
  </select>


  <!-- 推荐人的奖励完成总吨数 -->
  <select id="getSumRecomRewards" resultType="java.math.BigDecimal">
    SELECT
      sum(t.weight)
    FROM ml_recom_reward t  WHERE user_id = #{userId}  and referee_id=#{recomUserId} and vip_name = #{vipName}
  </select>


  <!-- 保存推荐奖励 -->
  <select id="saveRecomReward" parameterType="com.malicn.server.domain.reward.RecomReward">
    insert into ml_recom_reward(
        <include refid="base_column"/>
    )values(
      #{userId},
      #{refereeId},
      #{orderId},
      #{weight},
      #{amount},
      now(),
      #{vipId},
      #{vipName}
     )
    </select>

</mapper>