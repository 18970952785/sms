<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.malicn.server.dao.user.UserCarrierDao" >

  <resultMap id="userCarrierMap" type="com.malicn.server.domain.user.UserCarrier">
      <id column="user_id" property="userId" />
      <result column="carrier_type" property="carrierType" />
      <result column="balance" property="balance" />
      <result column="pre_balance" property="preBalance" />
      <result column="id_img" property="idImg" />
      <result column="id_card" property="idCard" />
      <result column="real_name" property="realName" />
      <result column="company_name" property="companyName" />
      <result column="company_img" property="companyImg" />
      <result column="personal_auth_status" property="personalAuthStatus" />
      <result column="company_auth_status" property="companyAuthStatus" />
      <result column="auth_pass_time" property="authPassTime" />
      <result column="create_time" property="createTime" />
      <result column="update_time" property="updateTime" />
  </resultMap>

    <sql id="all_columns">
        user_id,carrier_type, balance,pre_balance,id_img, id_card, real_name, company_name, company_img,
        personal_auth_status, auth_pass_time, create_time,update_time,is_deleted
    </sql>

  <!-- 修改车主余额 -->
      <update id="updateBalance">
        UPDATE ml_user_carrier SET balance = balance + ${carrierAmount}
        WHERE user_id=#{carrierId}
      </update>

    <!-- 验收成果，将订单的车主金额和车主的余额累加，并把用预支付余额减去订单的车主金额 -->
    <update id="updateBalanceByAccept">
        UPDATE ml_user_carrier SET balance = ${balance}, pre_balance = ${preBalance}
        WHERE user_id=#{carrierId}
    </update>

    <select id="listUserCarriersByVehicleId" resultMap="userCarrierMap">
        SELECT a.company_name, a.real_name
        FROM ml_user_carrier a, ml_carrier_vehicle b
        WHERE a.user_id = b.carrier_id AND a.carrier_type != 1 AND b.relation_type != 2 AND a.is_deleted = 0 AND a.user_id != 1
        AND b.is_deleted = 0 AND b.vehicle_id = #{vehicleId}
    </select>

    <!-- 获取公司信息 -->
    <select id="getUserCarrierByUserId"  parameterType="java.lang.Long" resultMap="userCarrierMap">
        SELECT <include refid="all_columns"/> FROM ml_user_carrier WHERE user_id = #{carrierId} and user_id != 1;
    </select>

    <select id="getUserCarrier"  parameterType="java.lang.Long" resultMap="userCarrierMap">
        SELECT <include refid="all_columns"/> FROM ml_user_carrier WHERE user_id = #{carrierId};
    </select>

    <!-- 新增操作 -->
  <insert id="saveUserCarrier" parameterType="com.malicn.server.domain.user.UserCarrier">
      INSERT INTO ml_user_carrier
      (user_id,carrier_type,balance,id_img,id_card,real_name,company_name,company_img,personal_auth_status,company_auth_status,auth_pass_time,create_time,update_time)
      VALUES
      (#{userId},#{carrierType},#{balance},#{idImg},#{idCard},#{realName},#{companyName},#{companyImg},#{personalAuthStatus},#{companyAuthStatus},#{authPassTime},now(),now())
  </insert>

    <insert id="insertSelective" parameterType="com.malicn.server.domain.user.UserCarrier" >
        insert into ml_user_carrier
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="userId != null" >
                user_id,
            </if>
            <if test="carrierType != null" >
                carrier_type,
            </if>
            <if test="balance != null" >
                balance,
            </if>
            <if test="preBalance != null">
                pre_balance,
            </if>
            <if test="idImg != null" >
                id_img,
            </if>
            <if test="idCard != null" >
                id_card,
            </if>
            <if test="realName != null" >
                real_name,
            </if>
            <if test="companyName != null" >
                company_name,
            </if>
            <if test="companyImg != null" >
                company_img,
            </if>
            <if test="personalAuthStatus != null" >
                personal_auth_status,
            </if>
            <if test="companyAuthStatus != null" >
                company_auth_status,
            </if>
            <if test="authPassTime != null" >
                auth_pass_time,
            </if>
            <if test="isDeleted != null" >
                is_deleted,
            </if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="userId != null" >
                #{userId,jdbcType=BIGINT},
            </if>
            <if test="carrierType != null" >
                #{carrierType,jdbcType=TINYINT},
            </if>
            <if test="balance != null" >
                #{balance,jdbcType=DECIMAL},
            </if>
            <if test="preBalance != null">
                #{preBalance},
            </if>
            <if test="idImg != null" >
                #{idImg,jdbcType=VARCHAR},
            </if>
            <if test="idCard != null" >
                #{idCard,jdbcType=VARCHAR},
            </if>
            <if test="realName != null" >
                #{realName,jdbcType=VARCHAR},
            </if>
            <if test="companyName != null" >
                #{companyName,jdbcType=VARCHAR},
            </if>
            <if test="companyImg != null" >
                #{companyImg,jdbcType=VARCHAR},
            </if>
            <if test="personalAuthStatus != null" >
                #{personalAuthStatus,jdbcType=TINYINT},
            </if>
            <if test="companyAuthStatus != null" >
                #{companyAuthStatus,jdbcType=TINYINT},
            </if>
            <if test="authPassTime != null" >
                #{authPassTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null" >
                #{isDeleted,jdbcType=TINYINT},
            </if>
            <choose>
                <when test="createTime != null">
                    #{createTime,jdbcType=TIMESTAMP}
                </when>
                <otherwise>
                    now()
                </otherwise>
            </choose>
        </trim>
    </insert>

  <!-- 修改操作 -->
  <update id="updateUserCarrier" parameterType="com.malicn.server.domain.user.UserCarrier" >
      UPDATE ml_user_carrier
      <set>
          <if test="carrierType != null">
            carrier_type = #{carrierType},
          </if>
          <if test="balance != null">
            balance = #{balance},
          </if>
          <if test="idImg != null">
            id_img = #{idImg},
          </if>
          <if test="idCard != null">
            id_card = #{idCard},
          </if>
          <if test="realName != null">
            real_name = #{realName},
          </if>
          <if test="companyName != null">
            company_name = #{companyName},
          </if>
          <if test="companyImg != null">
            company_img = #{companyImg},
          </if>
          <if test="personalAuthStatus != null">
            personal_auth_status = #{personalAuthStatus},
          </if>
          <if test="companyAuthStatus != null">
            company_auth_status = #{companyAuthStatus},
          </if>
          <if test="authPassTime != null">
              auth_pass_time = #{authPassTime},
          </if>
          update_time = now()
      </set>
      <where>
          user_id = #{userId}
      </where>
  </update>
    <!--=====================================CMS 新增方法=========================================-->
    <!-- 订单确认时，初始化议价者余额 -->
    <update id="initCarrierBalance">
        UPDATE ml_user_carrier SET   <!-- 余额不变化，线下发放 -->  pre_balance= pre_balance+${carrierAmount}
        WHERE user_id=#{carrierId}
    </update>
    <!-- 订单回滚时，减去订单中的车主运费 -->
    <update id="minusCarrierBalance">
        UPDATE ml_user_carrier SET pre_balance = pre_balance-${carrierAmount}
        WHERE user_id = #{carrierId}
    </update>
</mapper>